{% macro add_extra_javascript(submit_button_verb) -%}
    <script type="text/javascript">
        $(document).ready(function(){
            $('#datatype-submit').on('click', function(e){
	         console.log('#datatype-submit called');

	        function appendError(message) {
                     $('#errors').append('<div class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>' + message + '</div>');
                }


                e.preventDefault();
                var definitions = {
                    'field_definitions': {},
                    'data_types': [],
                    'socrata': "{{socrata_source}}"
                }
                if(definitions['socrata'] == 'True'){
                    definitions['socrata'] = true
                } else {
                    definitions['socrata'] = false
                }
                var valid = true;
                $('#errors').empty()
                $.each($('.plenario-field option'), function(i, opt){
                    var field_name = $(opt).parent().parent().next().text();
                    if($(opt).is(':selected')){
                        var field_type = $(opt).text().split(' ').join('_').toLowerCase().replace(/-/g, '');
                        if (field_type){
                            if (typeof definitions['field_definitions'][field_type] !== 'undefined'){
                                valid = false
		                appendError('You defined more than one ' + $(opt).text());
                            } else {
                                definitions['field_definitions'][field_type] = field_name;
                            }
                        }
                    }
                });
                $.each($('.data-type option'), function(i, opt){
                    var field_name = $(opt).parent().parent().prev().text();
                    if($(opt).is(':selected')){
                        var d_type = $(opt).text().split(' ').join('_').toLowerCase().replace(/-/g, "")
                        if(d_type){
                            definitions['data_types'].push({
                                'field_name': field_name,
                                'data_type': d_type
                            })
                        } else {
                            valid = false;
                            appendError('Provide a data type for ' + field_name);
                        }
                    }

                })
                var defined = []
                $.each(definitions['field_definitions'], function(i, definition){
                    defined.push(i);
                })
                if(!(defined.indexOf('id_field') >= 0)){
                    valid = false
	   
                    appendError('You need to define a unique ID field');
                }
                if(!(defined.indexOf('date_field') >= 0)){
                    valid = false
                    appendError('You need to define a date/datetime field');
                }
                if(!(defined.indexOf('location') >= 0)){
                    if(!(defined.indexOf('latitude') >= 0) && !(defined.indexOf('longitude') >= 0)){
                        valid = false
                        appendError('You need to defined either a location field or a latitude and longitude field');
                    }
                }
                if(!$('#update-select').val()){
                    valid = false
                    appendError('You need to select an update frequency');
                } else {
                    definitions['update_frequency'] = $('#update-select').val();
                }



                if(valid){
                    definitions['view_url'] = $('input[name="dataset_url"]').val()
                    var data = JSON.stringify(definitions);

  	            {% if submit_button_verb == 'Contribute' %}

	                // XXX: insert error checking code for email.
			// We can do this on the client side if we want submitting contributions to be part of the API,
	                // or server side if we don't.

		        console.log('submitting..');
	                $.post('/v1/api/contribute-dataset/', {'data': data}, function(resp){
	                    console.log("HELLLO "); console.log(resp);
	                    //window.location = "/admin/contribute-thankyou/";
	                })

	            {% else %}

                        $.post('/v1/api/submit-dataset/', {'data': data}, function(resp){
                            console.log(resp);
	                    // XX: is this necessary?
                            //window.location = "/admin/view-datasets/";
                        })
	   
 	    {% endif %}
                }
            })
        })
    </script>
{%- endmacro %}
