{% extends 'base.html' %}
{% block title %}Add a dataset - Plenar.io{% endblock %}
{% block content %}
    <div class="row">
        <div class='col-md-10 col-md-offset-1'>
            <h2>Add a dataset</h2>
            <form role="form" method="POST">
                <div class="form-group">
                    {% if dataset_info %}
                    <input type="text" class="form-control" name="dataset_url" value="{{dataset_info.submitted_url}}" />
                    {% else %}
                    <input type="text" class="form-control" name="dataset_url" />
                    {% endif %}
                    <p class="help-block">Publicly available URL for a data source in CSV format.</p>
                </div>
                <div class="form-group">
                    <button class="btn btn-info" type="submit">Fetch details &raquo;</button>
                </div>
            </form>
        </div>
    </div>
    {% if errors %}
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <h4>There were some problems with your submission: </h4>
                {% for error in errors %}
                    <p>{{error}}</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if dataset_info %}
        {% if socrata_source %}
            {% include 'add-socrata-dataset.html' %}
        {% else %}
            {% include 'add-csv-dataset.html' %}
        {% endif %}
    {% endif %}
{% endblock content %}
{% block extra_javascript %}
    <script type="text/javascript">
        $(document).ready(function(){
            $('#datatype-submit').on('click', function(e){
                e.preventDefault();
                var definitions = {
                    'field_definitions': {},
                    'data_types': [],
                    'socrata': "{{socrata_source}}"
                }
                if(definitions['socrata'] == 'True'){
                    definitions['socrata'] = true
                } else {
                    definitions['socrata'] = false
                }
                var valid = true;
                $('#errors').empty()
                $.each($('.plenario-field option'), function(i, opt){
                    var field_name = $(opt).parent().parent().next().text();
                    if($(opt).is(':selected')){
                        var field_type = $(opt).text().split(' ').join('_').toLowerCase().replace(/-/g, '');
                        if (field_type){
                            if (typeof definitions['field_definitions'][field_type] !== 'undefined'){
                                valid = false
                                $('#errors').append('<p><strong>You defined more than one ' + $(opt).text() + '</strong></p>')
                            } else {
                                definitions['field_definitions'][field_type] = field_name;
                            }
                        }
                    }
                });
                $.each($('.data-type option'), function(i, opt){
                    var field_name = $(opt).parent().parent().prev().text();
                    if($(opt).is(':selected')){
                        var d_type = $(opt).text().split(' ').join('_').toLowerCase().replace(/-/g, "")
                        if(d_type){
                            definitions['data_types'].push({
                                'field_name': field_name,
                                'data_type': d_type
                            })
                        } else {
                            valid = false;
                            $('#errors').append('<p><strong>Provide a data type for ' + field_name + '</strong></p>')
                        }
                    }

                })
                var defined = []
                $.each(definitions['field_definitions'], function(i, definition){
                    defined.push(i);
                })
                if(!(defined.indexOf('id_field') >= 0)){
                    valid = false
                    $('#errors').append('<p><strong>You need to define a unique ID field</strong></p>')
                }
                if(!(defined.indexOf('date_field') >= 0)){
                    valid = false
                    $('#errors').append('<p><strong>You need to define a date/datetime field</strong></p>')
                }
                if(!(defined.indexOf('location') >= 0)){
                    if(!(defined.indexOf('latitude') >= 0) && !(defined.indexOf('longitude') >= 0)){
                        valid = false
                        $('#errors').append('<p><strong>You need to defined either a location field or a latitude and longitude field</strong></p>')
                    }
                }
                if(!$('#update-select').val()){
                    valid = false
                    $('#errors').append('<p><strong>You need to select an update frequency</strong></p>')
                } else {
                    definitions['update_frequency'] = $('#update-select').val();
                }
                if(valid){
                    definitions['view_url'] = $('input[name="dataset_url"]').val()
                    var data = JSON.stringify(definitions);
                    $.post('/v1/api/submit-dataset/', data, function(resp){
                        console.log(resp);
                        window.location = "/view-datasets/";
                    })
                }
            })
        })
    </script>
{% endblock %}
